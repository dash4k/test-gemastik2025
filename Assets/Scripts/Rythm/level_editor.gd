extends Node2D

const in_edit_mode: bool = false
var current_level_name = "01_Tutorial_Music"

var sk_scroll_time: float = 2.43
var sk_output_arr = [[],[],[],[]]

var level_info = {
	"Disco_01" = {
		"sk_times": "[[1.40129262924194, 4.15285713195801, 6.0191605758667, 7.41816360473633, 9.27285701751709, 11.0956233215332], [0.0139001083374, 2.31848079681396, 2.7770746421814, 5.54895669937134, 7.8767569732666, 10.1697276306152], [0.931088514328, 3.23566896438599, 4.64337856292725, 6.94795925140381, 8.82587272644043, 10.6283219528198, 12.044739074707], [0.49281174659729, 1.88020402908325, 3.69426280975342, 5.08165533065796, 6.49807292938232, 8.3440592956543, 9.71984130859375, 11.5774377059937]]",
		"music": load("res://Assets/Music/Disco_01.mp3")
	},
	"Disco_02" = {
		"sk_times": "[[0.29253966331482, 1.57253963470459, 3.70587284088135, 5.00619060516357, 5.87113410949707, 6.09462577819824, 8.41952354431152, 9.27285701751709, 9.48473960876465, 10.5731747817993], [1.14587289810181, 3.23566896438599, 4.55920631408691, 5.44446689605713, 6.26587326049805, 7.9928572845459, 10.1145804595947], [0.70759636878967, 0.91947848320007, 2.42587310791016, 2.63775522232056, 2.86124736785889, 6.71285755157471, 7.56619007110596, 7.76936466217041, 9.71984130859375], [-0.18927448272705, 1.98759634017944, 4.14124710083008, 4.35603172302246, 7.11920673370361, 8.83458072662354, 11.0042861175537, 11.2233336639404]]",
		"music": load("res://Assets/Music/Disco_2.mp3")
	},
	"Hard Disc" = {
		"sk_times": "[[3.6739457321167, 4.16446716308594, 5.73181373596191, 6.20201808929443, 7.18306095123291, 8.73009044647217, 9.19739181518555, 10.1058734130859, 10.4454644393921, 11.2465537261963, 12.2275965881348, 13.0606120300293, 14.253536529541, 15.1939452362061, 15.1939452362061, 16.2591613006592, 16.7293647003174, 17.208277053833, 17.208277053833], [5.49671203613281, 6.70124752044678, 7.69390041351318, 8.24827701568604, 9.74306137084961, 11.0956233215332, 12.076667137146, 12.4626982879639, 13.4756692123413, 14.5089572143555, 15.4261458587646, 17.7104075622559], [5.0584352684021, 5.21807271957397, 7.07566864013672, 7.45879776000977, 9.10160953521729, 11.7254651260376, 12.7065079879761, 13.7107718658447, 14.1055110168457, 15.0749438476563], [4.04546482086182, 4.4721315574646, 4.69562370300293, 6.07140571594238, 6.45743782043457, 8.07702953338623, 8.47176868438721, 9.50795871734619, 10.2219727706909, 10.7008841705322, 11.5019725036621, 13.1970294189453, 14.7440589141846, 15.6728575897217, 16.0472796630859, 16.4942630004883, 17.0602496337891, 17.4753058624268]]",
		"music": load("res://Assets/Music/Hard Disc.mp3")
	},
	"Rythm_2_Disco" = {
		"sk_times": "[[0.10968262672424, 0.6872788143158, 2.10369617462158, 3.08473903656006, 4.45181400299072, 4.71884376525879, 5.20936519622803, 7.7142174911499, 8.68655330657959, 9.71113426208496, 10.4135373306274, 11.4178002548218, 13.1447842788696], [1.15458042144775, 3.40691596984863, 6.07140571594238, 6.73317462921143, 8.40791351318359, 10.0420182418823, 11.6848300170898, 12.1202042770386, 12.471406288147, 12.718118019104], [0.46088439941406, 1.72056705474854, 2.72482997894287, 3.6739457321167, 5.72020370483398, 7.21498901367188, 9.18868476867676, 11.0549882125855], [1.4651473236084, 2.4345806312561, 4.08900243759155, 6.41390068054199, 8.05671245574951, 10.7008841705322]]",
		"music": load("res://Assets/Music/Rhytm_2_Disco.mp3")
	},
	"Rythm_1_Jazz" = {
		"sk_times": "[[-0.20959179878235, 1.70895702362061, 3.6739457321167, 4.93072540283203, 5.38931972503662, 6.70124752044678, 7.70551044464111, 8.97390014648438, 9.71113426208496, 10.9795239639282, 11.4584353637695, 11.7370751571655, 14.6918147277832], [0.18514735221863, 2.15884334564209, 3.38369590759277, 6.17879802703857, 6.9566662979126, 8.73009044647217, 10.7008841705322], [0.72791392326355, 2.65807277679443, 4.17317468643189, 5.68827659606934, 8.227958984375, 10.2335828018188, 12.2072785568237, 12.9532197189331], [0.931088514328, 1.42160994529724, 2.90478450775146, 4.69562370300293, 7.43848068237305, 9.45281154632568, 12.6542628479004, 13.4321311187744, 13.7310889434814, 14.2216094207764, 15.2258723449707]]",
		"music":load("res://Assets/Music/Rythm_1_Jazz.mp3")
	},
	"Trap_01" = {
		"sk_times": "[[1.88020402908325, 2.90478450775146, 2.90478450775146, 3.63040811538696, 4.34442169189453, 5.75213176727295, 6.80863983154297, 7.51394588470459, 7.8767569732666, 8.91004497528076, 9.62405902862549, 10.3293650817871, 11.0433791351318, 11.7486851882935, 12.4830163192749, 13.1563943099976], [1.40999991416931, 2.03113395690918, 2.03113395690918, 2.75675756454468, 3.45916110992432, 4.13253957748413, 4.83494312286377, 6.28619033813477, 6.9566662979126, 6.9566662979126, 7.68229038238525, 8.37598640441895, 9.11321956634522, 9.80691654205322, 10.5093196105957, 11.2030156326294, 11.9286397171021, 12.6542628479004, 13.3247388076782], [1.05009061813354, 1.70895702362061, 2.38233549118042, 3.07603151321411, 3.83358270645142, 4.50405914306641, 5.18614513397217, 5.58088428497314, 5.92337829589844, 6.63739234924316, 7.34269840240479, 8.03639442443848, 8.73879844665527, 9.47603160858154, 10.1581175994873, 10.88374168396, 11.5774377059937, 12.2798417282105, 12.9735377502441, 12.9735377502441, 13.6556227874756, 13.6556227874756], [1.26197273254395, 1.58124715805054, 2.24301607131958, 2.56229001998901, 3.29081613540649, 4.00482971191406, 4.70723373413086, 5.04972774505615, 5.38061220169067, 6.10333377838135, 6.43421775817871, 7.15113384246826, 8.227958984375, 8.55884391784668, 9.28446704864502, 9.98687107086182, 10.7124942016602, 11.3858731460571, 12.1114962768555, 12.8255103302002, 13.507596321106]]",
		"music": load("res://Assets/Music/Trap_01.mp3")
	},
	"01_Tutorial_Music" = {
		"sk_times": "[[1.4651473236084, 2.24301607131958, 3.77843553543091, 4.69562370300293, 6.14687091827393, 7.66197235107422, 9.01743728637695, 10.6689570617676], [3.17181427001953, 5.12229043960571, 6.74478466033936, 8.59947807312012, 10.4773925018311], [1.88020402908325, 3.01217681884766, 4.49535161972046, 5.99884349822998, 8.07702953338623, 9.71984130859375], [0.94269830703735, 2.64936525344849, 5.59249431610107, 7.49072582244873, 9.17707473754883, 11.1594784927368]]",
		"music": load("res://Assets/Music/01_Tutorial_Music.mp3")
	}
}

func _ready() -> void:
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		RythmSignals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var sk_times = level_info.get(current_level_name).get("sk_times")
		var sk_times_arr = str_to_var(sk_times)
	
		var counter: int = 0
		for key in sk_times_arr:
			
			var arrow_direction: String = ""
			match counter:
				0:
					arrow_direction = "ui_left"
				1:
					arrow_direction = "ui_right"
				2:
					arrow_direction = "ui_up"
				3:
					arrow_direction = "ui_down"
			
			for delay in key:
				SpawnScrollingKey(arrow_direction, delay)
			
			counter += 1
			
func KeyListenerPress(arrow_direction: String, array_num: int):
	#print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	sk_output_arr[array_num].append($MusicPlayer.get_playback_position() - sk_scroll_time)

func SpawnScrollingKey(arrow_direction: String, delay: float):
	await get_tree().create_timer(delay).timeout
	RythmSignals.CreateArrow.emit(arrow_direction)


func _on_music_player_finished() -> void:
	print(sk_output_arr)
